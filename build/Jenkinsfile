pipeline {
    
    agent any
    
    stages {
    
        /**
         * SETUP AND INSTALL PYTHON
         */
        stage('Setup Python Environment') {
            agent {
                docker { image 'python:3.7.3-stretch' }
            }
            steps {
                sh 'make setup'
            }
        }
        stage('Install Dependencies') {
            agent {
                docker { image 'python:3.7.3-stretch' }
            }
            steps {
                script {
                    venv('make install')
                }
            }
        }
        
        /**
         * LINT PYTHON AND DOCKER
         */
        stage('Lint Python') {
            agent {
                docker { image 'python:3.7.3-stretch' }
            }
            steps {
                script {
                    withEnv(['PYLINTHOME=.']) {
                        venv('make lint_python')
                    }
                }
            }
        }
        stage('Lint Dockerfile') {
            agent {
                docker { image 'hadolint/hadolint' }
            }
            steps {
                sh 'hadolint Dockerfile'
            }
        }
        
        /**
         * BUILD AND PUSH DOCKERFILE
         */
        stage('Build Docker') {
            steps {
                sh '''
                    dockerpath=mithie/capstone
                    
                    echo "building docker image with build number ${currentBuild.number}"
                    docker build --tag=capstone:${currentBuild.number} .
                    docker tag capstone:${currentBuild.number} $dockerpath:${currentBuild.number}
                    docker push $dockerpath:${currentBuild.number}
                '''
            }
        }
    }
}

def venv(String script) {
    sh ". venv/bin/activate && " + script
}